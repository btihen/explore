= Crystal Lang Explorations -- Web SSL Server
:source-highlighter: prettify
:source-language: crystal
Bill Tihen (Crystal 0.32.1)

:sectnums:
:toc:
:toclevels: 4
:toc-title: Contents

:description: Exploring Crystal's Features
:keywords: Crystal Language
:imagesdir: ./images

*link:index.html[Crystal Page]*

== Basic Web SSL Server

=== First generate a self signed cert

https://www.akadia.com/services/ssh_test_certificate.html
* Step 1: Generate a Private Key
```bash
$ openssl genrsa -des3 -out server.key 1024
```
* Step 2: Generate a CSR
```bash
$ openssl req -new -key server.key -out server.csr
```
* Step 3: Remove Passphrase from Key
```bash
$ cp server.key server.key.org
$ openssl rsa -in server.key.org -out server.key
```
* Step 4: Generating a Self-Signed Certificate
```bash
$ openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
```

=== Write the SSL Server Code

.code/crystal/src/web_server/web_ssl_server.cr
[source,linenums]
----
# A very basic HTTPS server
require "openssl"
require "http/server"

def ssl_config
  tls = OpenSSL::SSL::Context::Server.new
  tls.private_key = "./server.key"
  tls.certificate_chain = "./server.crt"
  tls
end

server = HTTP::Server.new do |context|
  # get incoming request
  path = context.request.path

  # log request to stdout - for fun
  puts "HTTP request for path: #{path}"

  # build / send response
  context.response.content_type = "text/plain"
  context.response.print "Hello world, got #{path}!"

end
server.bind_tls "localhost", 8443, ssl_config 
puts "Listening on http://127.0.0.1:8443"
server.listen
----

Run with
```bash
$ crystal code/crystal/src/web_server/web_ssl.cr
```

Now open your browser to _(dismiss all the warnings about the self-signed cert)_
* http://localhost:8443
* http://localhost:8443/bill


=== Write an SSL web client

.code/crystal/src/web_server/web_ssl_client.cr
[source,linenums]
----
require "http/client"

response = HTTP::Client.get "https://localhost:8443"
puts response.status_code      
puts response.body.lines.each { |line| puts line }

response = HTTP::Client.get "https://localhost:8443/bill"
puts response.status_code      
puts response.body.lines.each { |line| puts line }

response = HTTP::Client.get "https://localhost:8443/bill/tihen"
puts response.status_code      
puts response.body.lines.each { |line| puts line }
----


*link:index.html[Crystal Page]*


